(function () {
  function showAd(attempts) {
    attempts = attempts || 1
    if (attempts > 3) return
    if (!window.showCodeFundAdvertisement) return setTimeout(function () { showAd(attempts + 1) }, 500)

    window.showCodeFundAdvertisement(
      '<%= @target || "codefund" %>',
      '<%= @advertisement_html.to_s.html_safe %>',
      '<%= @impression_url.to_s.strip %>',
      '<%= @campaign_url.to_s.strip %>',
      '<%= @powered_by_url.to_s.strip %>',
      '<%= ENV["ADBLOCK_PLUS_PIXEL_URL"].to_s.strip %>',
      '<%= @uplift_url.to_s.strip %>',
      <%= !!@campaign&.fallback? %>
    )
  }

  const codefundScriptId = 'codefund-script'
  if (document.getElementById(codefundScriptId)) {
    showAd(1)
  } else {
    const script = document.createElement('script')
    script.setAttribute('id', codefundScriptId)
    script.setAttribute('type', 'text/javascript')
    script.setAttribute('src', '<%= asset_pack_url "advertisements.js" %>')
    script.addEventListener('load', showAd)
    document.head.appendChild(script)
  }
})()
