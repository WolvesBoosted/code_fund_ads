// THIS FILE IS COPY OF: app/views/advertisements/show.js.erb
(function () {
  function init(attempts) {
    attempts = attempts || 1
    if (attempts > 3) return
    if (typeof CodeFundAd === 'undefined') return setTimeout(function () { init(attempts + 1) }, 500)
    const ad = new CodeFundAd(
      '<%= @target || "codefund" %>',
      '<%= @advertisement_html.to_s.html_safe %>',
      '<%= @impression_url.to_s.strip %>',
      '<%= @campaign_url.to_s.strip %>',
      '<%= @powered_by_url.to_s.strip %>',
      '<%= ENV["ADBLOCK_PLUS_PIXEL_URL"].to_s.strip %>',
      '<%= @uplift_url.to_s.strip %>',
      <%= !!@campaign&.fallback? %>
    )
    ad.perform(true) // <- THIS IS THE ONLY DIFFERENCE
  }

  const codefundStylesheetId = 'codefund-style'
  const codefundScriptId = 'codefund-script'

  if (!document.getElementById(codefundStylesheetId)) {
    const stylesheet = document.createElement('link')
    stylesheet.setAttribute('id', codefundStylesheetId)
    stylesheet.setAttribute('rel', 'stylesheet')
    stylesheet.setAttribute('media', 'all')
    stylesheet.setAttribute('href', '<%= asset_pack_url "code_fund_ad.css" %>')
    stylesheet.addEventListener('load', init)
    document.head.appendChild(stylesheet)
  }

  if (document.getElementById(codefundScriptId)) {
    init(1)
  } else {
    const script = document.createElement('script')
    script.setAttribute('id', codefundScriptId)
    script.setAttribute('type', 'text/javascript')
    script.setAttribute('src', '<%= asset_pack_url "code_fund_ad.js" %>')
    script.addEventListener('load', init)
    document.head.appendChild(script)
  }
})()
